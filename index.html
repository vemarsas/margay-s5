<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<title>Margay &mdash; Managing Network Security Appliances with Ruby and Sinatra</title>
<!-- metadata -->
<meta name="generator" content="S5" />
<meta name="version" content="S5 1.1" />
<meta name="presdate" content="20131009" />
<meta name="author" content="Guido De Rosa" />
<meta name="company" content="VEMAR s.a.s." />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<link rel="stylesheet" href="ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/default/print.css" type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/default/opera.css" type="text/css" media="projection" id="operaFix" />
<!-- S5 JS -->
<script src="ui/default/slides.js" type="text/javascript"></script>


<!-- Custom style -->
<style type="text/css">
  #slide0 h2 em {
    font-style: normal;
  }
  em {
    /* color: #226; */
  }
  h1 em, .slide h1 code {
    color: inherit;
  }
  .part {
    text-align:center; 
    margin-top:4em;
    font-size:140%;
  }
  pre {
    text-align: left;
  }
  a img {
    border: 0;
  }
  div.slide h1 {
    text-transform: none;
  }
  .slide ul li ul li {
    font-size:100%;
    margin-top: 0.75em;
  }
</style>

</head>
<body>

<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer">
<h1>Napoli, Città della Scienza, <em>“Smart Education & Technology Days”</em> - 9, 10, 11 ottobre 2013</h1>
<h2>Margay &mdash; Sicurezza (e Virtualizzazione) per la Scuola e oltre</h2>
</div>

</div>


<div class="presentation">

<div class="slide" id="slide0">
  <h1>A Linux-based Network Security, Access Control and Virtualization Appliance</h1>
  <h2>  
    Introducing <a href="http://www.margay.it/">MARGAY</a>, a ReSTful firewall, VPN router, AAA server, Web Content Filter and Private Cloud Management System
  </h2>

  <img src="img/margay-alpha-240.png" style="float:right;"/>

  <h3>Guido De Rosa</h3>

  <h4>
    <a href="http://dev.vemarsas.it/">VEMAR s.a.s.</a>
  </h4>
  <a href="http://dev.vemarsas.it/"><img src="img/vemar-logo.jpg" style="height:2em;"/></a>
</div>

<div class="slide">
  <h1><em>Margay</em> is a complete system</h1>
  <img src="img/3acrosser.png" style="float:right; height:13em;"/>
  <ul>
    <li>But you can get the web interface alone (a Sinatra application)</li>
    <li><a href="http://github.com/gderosa/onboard">http://github.com/gderosa/onboard</a></li>
    <li>And get it deployed on your own hardware...</li>
    <li>...with some sysadmin work ;)</li>
    <li>We support <em>Acrosser</em>, <em>Jetway</em>, <em>HP</em>, ...</li>
  </ul>
</div>

<div class="slide">
  <h1>Not-So-Embedded</h1>
  <img src="img/3acrosser.png" style="float:right; height:13em;"/>
  <ul>
    <li>A standard x86(_64) machine with GHz CPU and GiB+ RAM</li>
    <li>Can run DansGuardian + ClamAV (and afford content scanning)</li>
    <li>Can host a MySQL <em>server</em>, necessary for RADIUS AAA (something OpenWRT can not)</li>
    <li>Can run multiple QEMU/KVM virtual machines (in production: ERP, VoIP, Linux and Windows servers, etc.) (also with real hardware <em>passed-through</em>)</li>
    <li>A Cluster of MARGAYs: distributed storage, private clouds, ... </li>
  </ul>
</div>

<div class="slide">
  <h1>Not-So-Embedded</h1>
  <img src="img/debian/spacefun.png" style="float:right;"/>
  <ul>
    <li>Debian-based</li>
    <li>...but 99% independent upon distro-specific features</li>
    <li>Porting to non-Linux Unices would be non-trivial instead (iproute2, iptables, ...)</li>
    <li><code>~/.onboard/etc/config</code>(instead of <code>/etc</code>)</li>
    <li>Starts / stops / restores services on its own...</li>
    <li>...but un-managed services still handled by distro init scripts</li>
  </ul>
</div>

<div class="slide">
  <h1><em>Lots</em> of features...</h1>
  <ul>
    <li>...but this ain't a trade fair</div>
  </ul>
</div>

<div class="slide">
  <h1>The trade fair ;)</h1>
  <div style="text-align:right;">
    <img src="img/ospark.jpg" style="height:11em;"/>
    <img src="img/cebit11_logo_de_col.jpg" style="height:11em;"/>
    <img src="img/cebit-stand-h.jpeg" style="height:11em;"/>
  </div>
  <div>
    <small><a href="http://www.h-online.com/open/features/Open-Source-at-CeBIT-2011-1206993.html?page=3">http://www.h-online.com/open/features/Open-Source-at-CeBIT-2011-1206993.html?page=3</a></small>
  </div>
</div>

<div class="slide">
  <div class="part">
<pre>class OnBoard
  class Controller &lt; Sinatra::Base </pre>
  <img src="img/sinatra_logo.gif"/>
  </div>
</div>

<div class="slide">
  <h1>Why Sinatra (and Ruby)?</h1>
  <ul>
    <img src="img/ruby_logo.png" style="float:right; height:4em;"></img>
    <li>Lightweight (duh!)</li>
    <li>RESTful in a natural way</li>
    <li>Why RESTful?</li>
    <li>Poor-man SNMP&hellip; ?</li>
    <li>Each (human-readable) HTML page also provides JSON (and Ruby objects, in development)</li>
    <li>Error messages are HTTP statuses (even in the UI)</li>
    <li>Sound URLs: <code>/network/interfaces/eth0.html</code></li>
  </ul>
</div>

<div class="slide">
  <h1>RESTful Top-bar</h1>
  <img src="img/screen/restful-vpn.png" style="width:100%;"/>
</div>

<div class="slide">
  <h1 style="text-transform: none;">/network/openvpn.json</h1>
<pre>        },
        "subject": {
          "C": "IT",
          "ST": "NA",
          "L": "Napoli",
          "O": "Vemar sas",
          "CN": "napoli.vpn.vemarsas.it",
          "emailAddress": "guido.derosa@vemarsas.it"
        },
        "not_before": "2011-04-11 16:39:44 UTC",
        "not_after": "2021-04-08 16:39:44 UTC"
      },
      "dev-type": "tun",
      "dev": "ovpn_tun1",
      "client": {
        "Virtual Address": "10.179.239.10",
        "Bytes Received": "2000468",
        "Bytes Sent": "1893847",
        "Connected Since": "2011-04-11 17:47:39 +0000"
      },
      "remote": [
        {
          "address": "78.7.85.162",
          "port": "1194",
          "proto": "udp"
        }</pre>  
</div>

<div class="slide">
  <h1>MVC</h1>
  <ul>
    <li>Although Sinatra doesn't force you...</li>
    <li><code>controller/network/interfaces.rb</code> (routes)</li>
    <li><code>lib/onboard/network/interface.rb</code> (backend logic)</li>
    <li><code>views/network/interfaces.html.erubis</code> (templates)</li>
  </ul>
</div>

<div class="slide">
  <h1>Ancillary gem #1: <em>hierarchical_menu</em></h1>
  <img src="img/screen/hmenu-onboard.png" style="height:15em;"/>
  <a href="http://rubygems.org/gems/hierarchical_menu">http://rubygems.org/gems/hierarchical_menu</a>
</div>


<div class="slide">
  <h1>Ancillary gem #1: <em>hierarchical_menu</em></h1>
  <ul>
    <li>Very simple JS + CSS + Plain Ruby</li>
    <li><pre>root.add_path('/aaa/bbb/ccc/ddd', {
    :name =&gt; 'test1',
    :href =&gt; '/xxx/yyy/zzz.html',
    :custom_info =&gt; SomeStuff
  })</pre></li>
  <li><pre>root.to_html_ul do |node, output| 
    if node.content[:custom_info].some_check
      output[:extra_class] = 'hmenu-selected' # Expand
      output[:href] = nil                     # No hyperref
    end
  end</pre></li>
  </ul>
</div>

<div class="slide">
  <div class="part"><em>Core</em></div>
</div>

<div class="slide">
  <h1 style="text-transform:none;">Netfilter (aka <code style="color:inherit;">iptables</code>)</h1>
  <a href="img/screen/firewall.png" target="_blank"><img src="img/screen/firewall.png" style="height:15em;"/></a>
</div>

<div class="slide">
  <h1>IPv6</h1>
  <a href="img/screen/interfaces+ipv6.png" target="_blank"><img src="img/screen/interfaces+ipv6.png" style="width:35em;"/></a>
</div>

<div class="slide">
  <h1>Bridging</h1>
  <a href="img/screen/bridge.png" target="_blank"><img src="img/screen/bridge.png" style="height:15em;"/></a>
</div>

<div class="slide">
  <h1>Policy Routing</h1>
  <ul>
    <li>Route traffic according to its...</li>
    <li>...source</li>
    <li>...incoming network interface</li>
    <li>...incoming physical port (within a bridge)</li>
    <li>...QoS classification (DSCP)</li> 
  </ul>
</div>

<div class="slide">
  <h1>Policy Routing</h1>
  <ul>
    <li>Full power of <code>ip rule</code> and <code>iptables -t mangle</code></li>
    <li>As a sidenote: there <em>is</em> a standard Unix way to listen on a TCP socket...</li>
    <li>...but no portable way to assign IP addresses, IP routes, IP filters...</li>
    <li>The rude and simple way: <code>system()</code></li>
    <li>The sophisticated way: RTNETLINK (not my choice, though)</li>
  </ul>
</div>

<div class="slide">
  <h1>Policy Routing</h1>
   <a href="img/screen/policy-routing-tables.png" target="_blank"><img src="img/screen/policy-routing-tables.png" style=""/></a>
</div>

<div class="slide">
  <h1>Policy Routing</h1>
   <a href="img/screen/policy-routing-rules.png" target="_blank"><img src="img/screen/policy-routing-rules.png" style=""/></a>
</div>

<div class="slide">
  <div class="part"><em>Plugins (<code>modules/</code>)</em></div>
</div>

<div class="slide">
  <h1>SSL and VPN</h1>
  <img src="img/ovpn.howtoforge.jpg" style="float:right;"/>
  <ul>
    <li><code>modules/easy-rsa</code></li>
    <li><code>modules/openvpn</code>
  </ul>
</div>

<div class="slide">
  <h1>SSL and VPN</h1>
  <img src="img/screen/ovpn-details.png"/>
</div>

<div class="slide">
  <h1>SSL and VPN</h1>
  <img src="img/screen/ssl1.png"/>
</div>

<div class="slide">
  <h1>SSL and VPN</h1>
  <img src="img/screen/ssl2.png"/>
</div>



<div class="slide">
  <h1>Captive portal, AAA</h1>
  <div style="float:right;">
    <img src="img/coova-logo.png"/><br/>
    <img src="img/RADIUSAcct.preview.jpg"/><br/>
    <img src="img/Chilli_2.preview.jpg"/><br/>
  </div>
  <ul>
    <li><code>modules/chilli</code></li>
    <li><code>modules/hotspotlogin</code></li>
    <li><code>modules/radius-admin</code></li>
    <li><code>modules/radius-core</code></li>
    <li><em>hotspotlogin</em> gem</li>
  </ul>
</div>

<div class="slide">
  <h1>RADIUS Accounting</h1>
   <a href="img/screen/radius-accounting.png" target="_blank"><img src="img/screen/radius-accounting.png" style="height:14em;"/></a>
</div>


<div class="slide">
  <h1>Ancillary gem #2: <em>HotSpotLogin.rb</em></h1>
  <img src="img/screen/hotspot_logged_in.jpg" style="float:right; height:15em;"/>
  <ul>
    <li>Sinatra-based (again ;-)</li>
    <li>JS: queries the CoovaChilli JSON interface</li>
    <li><a href="http://rubygems.org/gems/hotspotlogin">http://rubygems.org/gems/hotspotlogin</a>
</div>

<div class="slide">
  <h1>Web Content Filter</h1>
  <img src="img/screen/dansguardian-filtergroup.png" style="float:right;"/>
  <ul>
    <li><code>modules/dansguardian</code></li>
    <li>
      Ancillary gem #3, #4: <em>dansguardian</em> and <em>configfiles</em>
      <ul>
        <li>a good idea?</li>
      </ul>
    </li>
  </ul>
</div>

<div class="slide">
  <h1>Integrating Captive Portal and Web Filtering</h1>
  <div style="float:right; line-height:0.4em;">
    <img src="img/freeradius.png" style="margin-bottom:1ex;"/><br/>
    <img src="img/dg.jpg" style="margin-bottom:0;"/>
    <div style="margin-top:0; margin-bottom:1em;"><span style="font-size:24px;">DansGuardian</span></div>
  </div>
  <ul>
    <li>User attempts to surf the web</li>
    <li>Gets redirected to a login page</li>
    <li>After authentication and authorization, traffic is accounted</li>
    <li><b>Differentiated, transparent content filters</b> (according to which user you are and which group you belong)</li>
    <li>Public WiFi, Schools, ...</li>
    <li>Virus scanning, children safety...</li>
  </ul>
</div>


<div class="slide">
  <h1>Integrating Captive Portal and Web Filtering</h1>
  <h2>The <em>SQLAuth</em> DansGuardian plugin</h2>
  <a href="http://github.com/gderosa/dansguardian">http://github.com/gderosa/dansguardian</a></li>
  <div style="float:right; line-height:0.4em;">
    <img src="img/freeradius.png" style="margin-bottom:1ex;"/><br/>
    <img src="img/dg.jpg" style="margin-bottom:0;"/>
    <div style="margin-top:0; margin-bottom:1em;"><span style="font-size:24px;">DansGuardian</span></div>
  </div>
  <ul>
    <li>Non-trivial (as the IP plugin)</li>
    <li>OS/network architecture independent (compared to NTLM)</li>
    <li>Compatible with <em>transparent</em> proxies (no Proxy-based Auth)</li>
    <li>C++ development on top of the SOCI library</li>
  </ul>
</div>

<div class="slide">
  <div class="part">
    <em>Anatomy of a module (or how to create your own)</em>
  </div>
</div>

<div class="slide">
  <h1>Plugin Anatomy</h1>
  <ul>
    <li>Same directory layout of core</li>
    <li><code>Sinatra::Base</code> has been opened to allow multiple paths for static files and views</li>
    <li>Installing and uninstalling is just a matter of copying or deleting a directory</li>
    <li>Current example: the ChilliSpot module</li>
  </ul>
</div>

<div class="slide">
  <h1><code><span style="color:#888">modules/chilli/</span>load.rb</code></h1>  
  <pre>
class OnBoard
  module Network
    module AccessControl
      class Chilli
        ROOTDIR = File.dirname(__FILE__)
        CONFDIR = 
            "#{OnBoard::CONFDIR}/network/access-control/chilli"
        $LOAD_PATH.unshift  ROOTDIR + '/lib'
        if OnBoard.web?
          OnBoard.find_n_load ROOTDIR + '/etc/menu'
          OnBoard.find_n_load ROOTDIR + '/controller'
        end
      end
    end
  end
  CHILLI_CLASS = Network::AccessControl::Chilli # a shortcut
end
  </pre>
</div>



<div class="slide">
  <h1>Menu</h1>
  <h2><code>modules/chilli/<br/>etc/menu/network/access-control/chilli.rb</code></h2>
  <pre>

class OnBoard
  MENU_ROOT.add_path('/network/access-control/chilli', {
    :href     =&gt; '/network/access-control/chilli',
    :name     =&gt; '&ldquo;Chilli&rdquo; Controller',
    :desc     =&gt; 'Redirects unauthenticated users to a login page',
    :n        =&gt; 0,
    :children =&gt; %r{^/network/access-control/chilli/.*}
  })
end
  </pre>
</div>

<div class="slide">
  <h1>Sinatra routes</h1>
  <h2><code>modules/chilli/<br/>controller/network/access-control/chilli.rb</code></h2>
  <pre>
    put '/network/access-control/chilli/:ifname.:format' do
...
            else
              raise CHILLI_CLASS::BadRequest, "UAM passwords do not match!"
            end
          else
            raise CHILLI_CLASS::BadRequest, "Wrong UAM password!" unless
                params['conf']['uamsecret'].length == 0 and
...
        rescue CHILLI_CLASS::BadRequest
          status 400
          msg[:err] = $!
          msg[:ok] = false
        end

  </pre>
</div>

<div class="slide">
  <h1>The <code>format</code> helper</h1>
  <h2><code>modules/chilli/<br/>controller/network/access-control/chilli.rb</code></h2>
  <pre>
    put '/network/access-control/chilli/:ifname.:format' do
...
        # refresh
        all = CHILLI_CLASS.getAll()
        chilli = all.detect{|x| x.conf['dhcpif'] == params[:ifname]}

        format(
          :module   =&gt; 'chilli',
          :path     =&gt; '/network/access-control/chilli/ifconfig',
          :format   =&gt; params[:format],
          :objects  =&gt; chilli,
          :msg      =&gt; msg
        )
      else
        not_found
      end
  </pre>
</div>


<div class="slide">
  <h1>Stuff under <code>lib/</code> ...</h1>
  <h2><code>modules/chilli/<br/>lib/network/access-control/chilli.rb</code></h2>
  <pre>
require 'onboard/extensions/ipaddr'
require 'onboard/system/process'
require 'onboard/network/interface'
require 'onboard/network/interface/ip'

class OnBoard
  module Network
    module AccessControl
      class Chilli
...
        class BadRequest &lt; RuntimeError; end
...
  </pre>
</div>

<div class="slide">
  <h1>Stuff under <code>lib/</code> ...</h1>
  <h2><code>modules/chilli/<br/>lib/network/access-control/chilli.rb</code></h2>
  <pre>
...
      class Chilli
...
        def self.parse_conffile(filename)
          h = {}
          return h unless File.exists? filename
          File.foreach(filename) do |line|
            line.sub! /#.*$/, ''
            if line =~ /(\S+)\s+(.*)\s*$/
              opt, arg = $1, $2
...
  </pre>
</div>

<div class="slide">
  <h1>Stuff under <code>lib/</code> ...</h1>
  <h2><code>modules/chilli/<br/>lib/network/access-control/chilli.rb</code></h2>
  <pre>
...
      class Chilli
...
        def self.parse_conffile(filename)
...
        def self.create_from_HTTP_request(params)
...
        def self.validate_conffile(h) # based on chilli_opt(1)
...
  </pre>
</div>

<div class="slide">
  <h1>Stuff under <code>lib/</code> ...</h1>
  <h2><code>modules/chilli/<br/>lib/network/access-control/chilli.rb</code></h2>
  <pre>
        def initialize(h)
          if h[:process]
              # Running Chilli instance
            @process = h[:process]
            @conffile = conffile()
            @conf = self.class.parse_conffile(@conffile)
            @managed = managed?
          elsif h[:conffile] and not h[:conf]
              # Not running, but a configuration file exists
            @process = nil
            @conffile = h[:conffile]
            @conf = self.class.parse_conffile(@conffile)
            @managed = managed?
            dynaconf_coaport unless @conf['coaport'].to_i &gt; 0
          elsif h[:conffile] and h[:conf]
              # We will have to (over-)write a configuration file
            @conffile = h[:conffile]
            @managed true
            @conf = h[:conf]

  </pre>
</div>


<div class="slide">
  <h1>Save and Restore</h1>
  <h2><code>modules/chilli/<br/>lib/network/access-control/chilli.rb</code></h2>
  <pre>
      class Chilli
        def self.save
          FileUtils.mkdir_p File.dirname SAVED_DAT_FILE
          all = getAll
          File.open SAVED_DAT_FILE, 'w' do |f|
            f.write Marshal.dump(getAll)
          end
        end

        def self.restore
          if File.exists? SAVED_DAT_FILE
            all_saved = Marshal.load File.read SAVED_DAT_FILE
            all_saved.map{|chilli| chilli.start if chilli.running?}
          end
        end
...
  </pre>
</div>

<div class="slide">
  <h1>SysV-like init hooks</h1>
  <h2><code>modules/chilli/<br/>etc/restore/60chilli.rb</code></h2>
  <pre>
require 'onboard/network/access-control/chilli'
OnBoard::Network::AccessControl::Chilli.restore

</pre>
  <h2><code>modules/chilli/<br/>etc/save/chilli.rb</code></h2>
  <pre>
require 'onboard/network/access-control/chilli'
OnBoard::Network::AccessControl::Chilli.save

</pre>
</div>

<div class="slide">
  <h1>Want to develop?</h1>
  <ul>
    <li>Ok, you deserve better docs ;-)</li>
    <li>
      Most wanted plugins:
      <ul>
        <li>IPSec vpn (talk to Cisco devices and mobile clients)</li>
        <li>Intrusion detection (Snort)</li>
        <li>VLAN</li>
        <li>PPPoE, PPPoA</li>
      </ul>
    </li>
    <li>GPL</li>
  </ul>
</div>

<div class="slide">
  <h1>Fork me on GitHub</h1>
  <ul>
    <li><a href="http://github.com/gderosa/onboard">http://github.com/gderosa/onboard</a> (and other projects)</li>
    <li><a href="http://dev.vemarsas.it/projects/onboard/wiki">http://dev.vemarsas.it/projects/onboard/wiki</a> (and other projects)</li>
    <!-- <li><a href="http://www.margay.it/s5/">http://www.margay.it/s5/</a> (this presentation)</li> -->
    <li><a href="http://www.margay.it/">http://www.margay.it/</a></li>
    <li>guido.derosa <em>at</em> vemarsas.it</li>
    <li>Thanks a lot!</li>
  </div>
</div>


</body>
</html>
